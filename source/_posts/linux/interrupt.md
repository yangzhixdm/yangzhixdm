---
title: 「读书笔记」-linux内核设计与实现-中断与中断处理
date: 2021-12-21 19:03:26
tags: linux
description: 硬件设备生成中断时并不考虑与处理器的时钟同步--换句话说就是中断随时可以产生。内核随时可能因为新来的中断而被打断。
---

### 中断
电信号，由硬件设备生成，并直接送入中断控制器的输入引脚下——中断控制器是个简单的电子芯片，作用是将多路中断管线，采用复用技术只通过一个和处理器相连的管线与处理器通信。

接收一个中断后，中断处理器会给处理器一个电信号。处理器检测到此信号，便中断自己当前的工作转而处理中断。此后，处理器会通知操作系统已经处理中断，这样，操作系统就可以对这个中断进行适当的处理了。

不同的设备对应的中断不同，每个中断都通过一个唯一的数字进行标记。
中断值通常被称为 IRQ 线。一般为固定值，但也有动态分配的。

### 异常
异常产生必须与处理器时钟同步。异常也经常被称为同步中断。异常大部分是由于处理器在执行期间出现特殊情况，必须要内核来处理，然后就会产生异常。


### 中断处理程序
响应一个特定中断，内核会执行一个处理函数（c语言函数），该函数就叫 中断处理程序。
中断处理程序执行在 中断上下文中，也被称为 原子上下文（执行过程不可被阻塞）

### 上半部和下半部
中断处理被分为两个部分或两半。中断处理程序为 上半部（top half)-接收中断，立即开始执行，但只做有严格时限的工作，例如对接收的中断进行应答或复位硬件。
能够被允许稍后执行的部分会推迟到下半部（bottom half)。

> 网卡接收到数据，网卡出发中断， cpu 接收到中断信号，然后执行中断处理程序，将数据拷贝到内存中，然后结束中断。 恢复到中断之前的状态。关于对数据的处理则延后到下半部中进行处理。

### 中断上下文
中断处理程序不能睡眠，因为没有后备程序。 
中断处理程序打断了其他的代码（甚至可能是打断了其他中断线上的另一中断处理程序）。
中断处理程序必须简洁，高效。

查看中断
``` bash
cat /proc/interrupts
```

第一列为中断号，第二列为 接收中断数据的计数器，第三列是处理这个中断的中断处理器，最后一列是中断相关的设备名称。

### 中断控制
内核提供了一组接口用于操作机器上的中断状态。这些接口可以为我们提供了能够禁用当前处理的中断系统，或者屏蔽这个歌机器的一条中断线的能力。